<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Estratégico de Valor FINAL | Café de Tere</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <style>
        /* PALETA DE COLORES */
        :root {
            --color-cafe-oscuro: #4E342E;
            --color-crema-fondo: #F5F5DC;
            --color-acento-naranja: #FF9800; /* Naranja Brillante */
            --color-naranja-oscuro: #E65100; /* Naranja Tostado (Gráficos/Conclusión) */
            
            /* Colores de Valor Mejorados */
            --color-riesgo-alto: #C62828; /* ROJO OSCURO/FUERTE para ALERTA/ALTO IMPACTO */
            --color-atencion-medio: #E65100; /* NARANJA OSCURO para ATENCIÓN/MEDIO IMPACTO */
            --color-oportunidad-verde: #388E3C; /* VERDE OSCURO/ESMERALDA para ACCIÓN/ESTABILIDAD */
            
            /* Fondos y Texto */
            --color-riesgo-fondo: #FFCDD2; 
            --color-oportunidad-fondo: #C8E6C9;
        }

        body {
            background-color: var(--color-crema-fondo);
            color: var(--color-cafe-oscuro);
        }
        .header {
            background-color: var(--color-cafe-oscuro);
            color: white;
            padding: 25px 0;
            margin-bottom: 25px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .text-secondary {
            color: var(--color-cafe-oscuro) !important;
            border-bottom: 2px solid var(--color-acento-naranja);
            padding-bottom: 5px;
        }
        .card-kpi {
            border-left: 5px solid var(--color-acento-naranja); 
            background-color: #FFF8E1 !important;
        }
        .conclusion-card {
            background-color: var(--color-naranja-oscuro) !important;
        }
        
        /* ESTILOS PARA LA TABLA DE ENTIDADES CONSOLIDADAS (Punto 2) */
        .table-topic thead th {
            color: white;
            vertical-align: middle;
            font-weight: bold;
        }
        .table-topic thead .risk-header { background-color: var(--color-riesgo-alto) !important; }
        .table-topic thead .opportunity-header { background-color: var(--color-oportunidad-verde) !important; }
        .risk-col { color: var(--color-riesgo-alto); font-weight: 500; }
        .opportunity-col { color: var(--color-oportunidad-verde); font-weight: 500; }
        
        /* CÓDIGO DE COLORES para la MATRIZ DE CORRELACIÓN (Punto 4) */
        .corr-high { 
            background-color: var(--color-riesgo-fondo) !important;
            color: var(--color-riesgo-alto) !important;
            font-weight: bold;
        }
        .corr-medium { background-color: #FFF3CD !important; }
        .corr-low { 
            background-color: var(--color-oportunidad-fondo) !important; 
            color: var(--color-oportunidad-verde) !important;
        }
    </style>
</head>
<body>

    <script>
        // --- DATOS JSON (Usando el archivo result_cafe_de_tere.json) ---
        const data = {
            "describe_matrix": {
                "count": { "favorite_count": 1198.0, "id": 1199.0, "retweet_count": 1198.0, "user.followers_count": 1198.0, "user.friends_count": 1198.0 },
                "mean": { "favorite_count": 12.202, "id": 1.1909e+18, "retweet_count": 33.926, "user.followers_count": 5046.369, "user.friends_count": 1021.627 },
                "max": { "favorite_count": 2733.0, "id": 1.1926e+18, "retweet_count": 28090.0, "user.followers_count": 1997889.0, "user.friends_count": 221536.0 }
            },
            "corr_matrix": {
                "user.followers_count": { "user.followers_count": 1.0, "user.friends_count": 0.577, "id": -0.145, "favorite_count": 0.374, "retweet_count": 0.128 },
                "user.friends_count": { "user.followers_count": 0.577, "user.friends_count": 1.0, "id": -0.093, "favorite_count": 0.164, "retweet_count": 0.054 },
                "id": { "user.followers_count": -0.145, "user.friends_count": -0.093, "id": 1.0, "favorite_count": -0.128, "retweet_count": 0.076 },
                "favorite_count": { "user.followers_count": 0.374, "user.friends_count": 0.164, "id": -0.128, "favorite_count": 1.0, "retweet_count": 0.121 },
                "retweet_count": { "user.followers_count": 0.128, "user.friends_count": 0.054, "id": 0.076, "favorite_count": 0.121, "retweet_count": 1.0 }
            },
            "heatmap": {
                "Monday": { "0.0": -1.0, "1.0": 0.0, "2.0": -1.0, "3.0": 0.0, "4.0": -1.0, "5.0": -1.0, "6.0": -1.0, "7.0": 0.0, "8.0": -1.0, "9.0": 0.0, "10.0": -1.0, "11.0": 0.0, "12.0": -1.0, "13.0": -1.0, "14.0": 1.0, "15.0": 1.0, "16.0": 3.0, "17.0": 177.0, "22.0": 2734.0, "23.0": 82.0 },
                "Tuesday": { "0.0": 1.0, "1.0": 32.0, "2.0": 20.0, "3.0": 0.0, "4.0": 3.0, "7.0": 1.0, "9.0": 0.0, "11.0": 1.0, "12.0": 3.0, "13.0": 73.0, "14.0": 195.0, "15.0": 18.0, "16.0": 175.0, "17.0": 102.0, "18.0": 1012.0, "19.0": 651.0, "20.0": 210.0, "21.0": 412.0, "22.0": 1555.0, "23.0": 1331.0 },
                "Wednesday": { "0.0": 209.0, "1.0": 906.0, "2.0": 1789.0, "3.0": 895.0, "4.0": 265.0, "5.0": 37.0, "6.0": 27.0, "7.0": 31.0, "8.0": 37.0, "9.0": 4.0, "10.0": 12.0, "11.0": 64.0, "12.0": 46.0, "13.0": 115.0, "14.0": 98.0, "15.0": 76.0, "16.0": 36.0, "17.0": 160.0, "18.0": 24.0, "19.0": 34.0, "20.0": 22.0, "21.0": 282.0, "22.0": 65.0, "23.0": 83.0 }
            },
            "topics": {
                "topics": [
                    { "title": "Precio y percepción de valor", "detail": "Fuerte polarización: para muchos es “caro/sobrevalorado” (bolón $3,5–$5, jugos hasta $8, extras como huevo $1, mínimos de delivery altos); otros justifican que se paga limpieza, local, marca y servicio.", "challenge": "Definir estrategia de precios y porciones (combos, tamaños, “bolón popular” en franjas), hacer transparente la propuesta de valor y costos, y ofrecer beneficios (lealtad, horas felices) para mejorar la ecuación valor/precio." },
                    { "title": "Calidad y consistencia del producto", "detail": "Opiniones dispares: “normalito”, “perdió sazón/industrializado”, tigrillo “sopudo/insípido”, bolón frío o muy salado, uso de lácteos excesivos o margarina vs otros que lo consideran excelente. Variabilidad entre locales.", "challenge": "Refinar y estandarizar recetas y procesos (temperatura, salado, grasas), auditorías sensoriales por local, KPIs de calidad en tiempo real y pilotos de receta “clásico criollo” vs “sello Tere” para reconciliar expectativas." },
                    { "title": "Medios de pago", "detail": "Reclamo recurrente por no aceptar tarjetas/datafast; fricción de usar solo efectivo; algunos declaran no volver por esta razón.", "challenge": "Habilitar POS, QR y billeteras; comunicar razones y fechas de implementación; incentivar pagos digitales con pequeños descuentos y reducir fuga de ventas." },
                    { "title": "Experiencia de servicio y operación en sala", "detail": "Limpieza muy valorada; críticas a autoservicio/recoger bandeja; colas; límites de ají por mesa; porciones percibidas como pequeñas vs precio; confort (A/C) inconsistente.", "challenge": "Rediseñar flujos (señalética, estaciones de bandejas), gestionar picos (pre-order/pick-up), revisar política de porciones/extras/ají, asegurar A/C y confort constantes." },
                    { "title": "Delivery y agregadores", "detail": "Molestia por mínimos a domicilio (p.ej. $17) y cuentas altas en apps con porciones pequeñas.", "challenge": "Replantear mínimos por zona/hora, crear combos exclusivos de delivery y negociar comisiones con apps para sostener porción y precio percibido." }
                ],
                "conclusion": "La marca es icónica y altamente conversada, pero opera en un terreno polarizado donde el precio/valor, la consistencia del sabor, los medios de pago y la experiencia operativa generan fricción. Prioridades tácticas: 1) habilitar pagos con tarjeta/QR, 2) recalibrar y estandarizar recetas (en especial tigrillo/bolón) con control de temperatura y salado, 3) ajustar la propuesta de valor (porciones, combos y políticas de delivery/ají), 4) fortalecer el discurso de inclusión y emprendimiento con respuestas empáticas y 5) capitalizar la viralidad con activaciones y ofertas por canal. Ejecutar estas mejoras debería elevar satisfacción, reducir la conversación negativa y sostener el crecimiento sin sacrificar autenticidad."
            }
        };
        // --- FIN DE DATOS JSON ---

        function formatNumber(num) {
            if (num >= 1000) {
                return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
            }
            return num.toFixed(2).replace(/\.00$/, '');
        }
        
        // CORRECCIÓN FINAL GARANTIZADA: FUNCIÓN para generar el gráfico de Correlación con colores
        function createCorrelationChart() {
            const variables = ['favorite_count', 'retweet_count', 'user.followers_count', 'user.friends_count'];
            const labelsMap = { 
                'favorite_count': 'Likes', 
                'retweet_count': 'Retweets', 
                'user.followers_count': 'Seguidores', 
                'user.friends_count': 'Amigos' 
            };
            const labelsX = variables.map(v => labelsMap[v]);
            
            // Un solo array para todos los puntos, forzando el color individual
            const allDataPoints = [];
            const backgroundColors = [];

            variables.forEach((variableX, xIndex) => {
                variables.forEach((variableY, yIndex) => {
                    const correlationValue = data.corr_matrix[variableX][variableY];
                    if (variableX === variableY) return; 

                    const point = { 
                        x: xIndex, 
                        y: correlationValue, 
                        labelY: labelsMap[variableY] 
                    };

                    allDataPoints.push(point);

                    // Asignación de color según el valor absoluto de la correlación
                    if (Math.abs(correlationValue) > 0.5) {
                        backgroundColors.push('var(--color-riesgo-alto)'); // ROJO
                    } else if (Math.abs(correlationValue) > 0.2) {
                        backgroundColors.push('var(--color-atencion-medio)'); // NARANJA
                    } else {
                        backgroundColors.push('var(--color-oportunidad-verde)'); // VERDE
                    }
                });
            });


            const corrChartCtx = document.getElementById('correlationChart').getContext('2d');
            new Chart(corrChartCtx, {
                type: 'scatter', 
                data: {
                    datasets: [
                        {
                            label: 'Correlaciones',
                            data: allDataPoints,
                            // Aplicar el array de colores directamente a los puntos
                            backgroundColor: backgroundColors, 
                            pointRadius: 8,
                            pointStyle: 'circle'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: -0.6, 
                            max: 1.1,
                            title: { display: true, text: 'Nivel de Correlación (Impacto)', color: 'var(--color-cafe-oscuro)' }
                        },
                        x: {
                            // Usar el tipo 'linear' con callback para simular categorías y permitir colores
                            type: 'linear', 
                            min: -0.5, 
                            max: labelsX.length - 0.5,
                            ticks: {
                                color: 'var(--color-cafe-oscuro)',
                                callback: function(value, index, values) {
                                    if (value >= 0 && value < labelsX.length) {
                                        return labelsX[value];
                                    }
                                }
                            },
                            title: { display: true, text: 'Variables Analizadas', color: 'var(--color-cafe-oscuro)' }
                        }
                    },
                    plugins: {
                        legend: { 
                            position: 'top', 
                            labels: { 
                                color: 'var(--color-cafe-oscuro)',
                                // Generar una leyenda custom, ya que tenemos un solo dataset
                                generateLabels: (chart) => {
                                    return [
                                        { text: 'Alto Impacto/Riesgo (> 0.5)', fillStyle: 'var(--color-riesgo-alto)', pointStyle: 'circle' },
                                        { text: 'Atención/Impacto Medio (> 0.2)', fillStyle: 'var(--color-atencion-medio)', pointStyle: 'circle' },
                                        { text: 'Baja Dependencia/Oportunidad (< 0.2)', fillStyle: 'var(--color-oportunidad-verde)', pointStyle: 'circle' }
                                    ];
                                }
                            } 
                        },
                        title: { display: true, text: 'GRÁFICO ESTRATÉGICO: Impacto Relativo de Métricas (Decisión: ¿Qué Variable Mueve a la otra?)', color: 'var(--color-cafe-oscuro)', font: { size: 16 } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const variableX = labelsX[Math.round(context.parsed.x)]; 
                                    const variableY = context.raw.labelY; 
                                    const yValue = context.parsed.y.toFixed(3);
                                    let classification = '';
                                    const absValue = Math.abs(context.parsed.y);
                                    if (absValue > 0.5) classification = ' (Alto Impacto/Riesgo)';
                                    else if (absValue > 0.2) classification = ' (Atención/Medio Impacto)';
                                    else classification = ' (Baja Dependencia/Oportunidad)';
                                    
                                    return `Correlación ${variableY} con ${variableX}: ${yValue}${classification}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Llenar KPIs y Conclusión
            document.getElementById('kpi-total-tweets').textContent = data.describe_matrix.count.id.toLocaleString();
            document.getElementById('kpi-avg-retweets').textContent = formatNumber(data.describe_matrix.mean.retweet_count);
            document.getElementById('kpi-max-engagement').textContent = data.describe_matrix.max.retweet_count.toLocaleString();
            document.getElementById('conclusion-text').textContent = data.topics.conclusion;
            
            // CONSOLIDACIÓN DE ENTIDADES (TABLA)
            const topicTableBody = document.getElementById('topics-table-body');
            data.topics.topics.slice(0, 5).forEach(topic => { 
                const row = topicTableBody.insertRow();
                row.insertCell().innerHTML = `<strong>${topic.title}</strong>`;
                row.insertCell().innerHTML = `<span class="risk-col">${topic.detail}</span>`;
                row.insertCell().innerHTML = `<span class="opportunity-col">${topic.challenge}</span>`;
            });


            // Gráfico 1: Táctico (Curva de Actividad)
            const hourlyTotals = {}; 
            for(let i = 0; i <= 23; i++) { hourlyTotals[i] = 0; }
            Object.keys(data.heatmap).forEach(day => {
                Object.keys(data.heatmap[day]).forEach(hourStr => {
                    const hour = parseInt(parseFloat(hourStr));
                    const value = data.heatmap[day][hourStr];
                    if (value > 0) { hourlyTotals[hour] += value; }
                });
            });

            const activityChartCtx = document.getElementById('activityChart').getContext('2d');
            new Chart(activityChartCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(hourlyTotals).map(h => `${h}:00`),
                    datasets: [{
                        label: 'Engagement Total por Hora',
                        data: Object.values(hourlyTotals),
                        backgroundColor: 'var(--color-naranja-oscuro)', 
                        borderColor: 'var(--color-acento-naranja)', 
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'GRÁFICO TÁCTICO: Curva de Actividad (Decisión: ¿A qué hora maximizar la publicación?)', color: 'var(--color-cafe-oscuro)', font: { size: 16 } }
                    }
                }
            });

            // Gráfico 2: Estratégico (Corregido)
            createCorrelationChart();

            // Llenar Tabla de Correlación (Punto 4)
            const corrTableBody = document.getElementById('corr-table-body');
            const variables = Object.keys(data.corr_matrix);
            
            const headerRow = document.createElement('tr');
            headerRow.insertCell().innerHTML = ''; 
            const labelsMapCorr = { 'user.followers_count': 'Seguidores', 'user.friends_count': 'Amigos', 'id': 'ID Tweet', 'favorite_count': 'Likes', 'retweet_count': 'Retweets' };

            variables.forEach(v => {
                const th = document.createElement('th');
                th.textContent = labelsMapCorr[v]; 
                headerRow.appendChild(th);
            });
            corrTableBody.parentNode.querySelector('thead').appendChild(headerRow);
            
            variables.forEach(rowVar => {
                const row = corrTableBody.insertRow();
                row.insertCell().innerHTML = `<strong>${labelsMapCorr[rowVar]}</strong>`; 
                variables.forEach(colVar => {
                    const value = data.corr_matrix[rowVar][colVar];
                    const cell = row.insertCell();
                    cell.textContent = value.toFixed(3);
                    
                    // Aplicar clases de color según el valor de correlación
                    if (Math.abs(value) > 0.5 && Math.abs(value) < 1) {
                        cell.classList.add('corr-high');
                    } else if (Math.abs(value) > 0.2) {
                        cell.classList.add('corr-medium');
                    } else if (Math.abs(value) < 0.2 && Math.abs(value) > 0.0) {
                        cell.classList.add('corr-low');
                    }
                });
            });
        });
    </script>
    <div class="header text-center">
        <h1>Dashboard Estratégico de Valor Consolidado | Café de Tere ☕</h1>
        <p class="lead">Decisiones de Negocio basadas en el análisis de redes sociales.</p>
    </div>

    <div class="container">

        <h2 class="mb-3 text-secondary">1. Entidades Cuantitativas Clave (Visión General)</h2>
        <div class="row mb-5">
            <div class="col-md-4">
                <div class="card card-kpi text-dark mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Total de Interacciones Analizadas</h5>
                        <p class="card-text h2" id="kpi-total-tweets"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-kpi text-dark mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Promedio de Retweets por Mensaje</h5>
                        <p class="card-text h2" id="kpi-avg-retweets"></p>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-kpi text-dark mb-3 shadow-sm">
                    <div class="card-body">
                        <h5 class="card-title">Máximo Impacto (Pico de Viralidad)</h5>
                        <p class="card-text h2" id="kpi-max-engagement"></p>
                    </div>
                </div>
            </div>
        </div>

        <hr>

        <h2 class="mb-3 text-secondary">2. Matriz Consolidada de Riesgo y Oportunidad (Entidades de Valor)</h2>
        <div class="row mb-4">
            <div class="col-lg-12">
                <div class="card conclusion-card text-white mb-4 shadow-lg">
                    <div class="card-body">
                        <h4 class="card-title">Decisión de Valor Máxima (Prioridad de Inversión)</h4>
                        <p id="conclusion-text"></p>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mb-5">
             <div class="col-lg-12">
                <div class="table-responsive">
                    <table class="table table-bordered table-sm table-striped table-topic shadow-sm">
                        <thead>
                            <tr>
                                <th style="width: 20%;">Entidad Clave</th>
                                <th style="width: 40%;" class="risk-header">Riesgo (Fricción / Detalle)</th>
                                <th style="width: 40%;" class="opportunity-header">Oportunidad (Acción de Valor / Mejora)</th>
                            </tr>
                        </thead>
                        <tbody id="topics-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <hr>

        <h2 class="mb-3 text-secondary">3. Gráficos para Decisiones Estratégicas y Tácticas (Por Color de Valor)</h2>
        <div class="row mb-5">
            <div class="col-lg-12">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <canvas id="correlationChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <canvas id="activityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        
        <hr>
        
        <h2 class="mb-3 text-secondary">4. Evaluación de Riesgo/Impacto (Matriz de Correlación)</h2>
        <div class="row mb-5">
            <div class="col-lg-12">
                <h4 class="mb-3">Correlación para Medir Impacto (Decisión: ¿Dónde enfocar el esfuerzo de marketing?)</h4>
                <div class="table-responsive">
                    <table class="table table-bordered table-sm table-striped text-center">
                        <thead>
                            </thead>
                        <tbody id="corr-table-body">
                            </tbody>
                    </table>
                </div>
                <p class="small text-muted">
                    <span style="color: var(--color-riesgo-alto); font-weight: bold;">◼ Alto Riesgo/Impacto (> 0.5):</span> Fuerte dependencia. Invertir en una métrica impactará directamente en la otra.<br>
                    <span style="color: var(--color-atencion-medio); font-weight: bold;">◼ Atención/Impacto Medio (> 0.2):</span> Correlación considerable. Monitorear de cerca.<br>
                    <span style="color: var(--color-oportunidad-verde); font-weight: bold;">◼ Baja Dependencia/Oportunidad (< 0.2):</span> Estabilidad. Los cambios en una métrica no impactan mucho a la otra.
                </p>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
